import streamlit as st
import pandas as pd
import numpy as np
import os

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • (ë°˜ë“œì‹œ ì½”ë“œ ë§¨ ìœ—ì¤„ì— ìˆì–´ì•¼ í•¨)
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="í•œêµ­ ê´€ê´‘ì§€ ë°©ë¬¸ê° ë¶„ì„",
    page_icon="âœˆï¸",
    layout="wide"
)

# -----------------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ ë° ìƒì„± í•¨ìˆ˜
# -----------------------------------------------------------------------------
def create_mock_data():
    """ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì‚¬ìš©í•  ê°€ìƒì˜ í•œêµ­ ê´€ê´‘ì§€ ë°©ë¬¸ê° ë°ì´í„° ìƒì„±"""
    data = {
        'ê´€ê´‘ì§€ëª…': [
            'ì—ë²„ëœë“œ', 'ë¡¯ë°ì›”ë“œ', 'ê²½ë³µê¶', 'í‚¨í…ìŠ¤', 'ìˆœì²œë§Œêµ­ê°€ì •ì›', 
            'ë‚¨ì´ì„¬', 'ì„±ì‚°ì¼ì¶œë´‰', 'ê°•ì›ëœë“œ', 'ì „ì£¼í•œì˜¥ë§ˆì„', 'ë¶ˆêµ­ì‚¬',
            'í•´ìš´ëŒ€í•´ìˆ˜ìš•ì¥', 'Nì„œìš¸íƒ€ì›Œ', 'ì˜ë í”„ë‘ìŠ¤', 'ì•„ì¹¨ê³ ìš”ìˆ˜ëª©ì›', 'ë…ë¦½ê¸°ë…ê´€'
        ],
        'ì§€ì—­': [
            'ê²½ê¸°', 'ì„œìš¸', 'ì„œìš¸', 'ê²½ê¸°', 'ì „ë‚¨', 
            'ê°•ì›', 'ì œì£¼', 'ê°•ì›', 'ì „ë¶', 'ê²½ë¶',
            'ë¶€ì‚°', 'ì„œìš¸', 'ê²½ê¸°', 'ê²½ê¸°', 'ì¶©ë‚¨'
        ],
        'ë°©ë¬¸ê°ìˆ˜(ë§Œëª…)': [
            690, 580, 540, 520, 480, 
            310, 290, 280, 270, 250,
            240, 220, 180, 170, 160
        ],
        'ì¹´í…Œê³ ë¦¬': [
            'í…Œë§ˆíŒŒí¬', 'í…Œë§ˆíŒŒí¬', 'ë¬¸í™”ìœ ì‚°', 'ì „ì‹œê´€', 'ìì—°ìƒíƒœ',
            'ìì—°ê²½ê´€', 'ìì—°ê²½ê´€', 'ë ˆì €', 'ë¬¸í™”ë§ˆì„', 'ë¬¸í™”ìœ ì‚°',
            'ìì—°ê²½ê´€', 'ëœë“œë§ˆí¬', 'í…Œë§ˆíŒŒí¬', 'ìˆ˜ëª©ì›', 'ì—­ì‚¬'
        ]
    }
    return pd.DataFrame(data)

@st.cache_data
def load_data():
    file_name = "korea_tourism.csv"
    
    # 1. í˜„ì¬ í´ë” í™•ì¸
    if os.path.exists(file_name):
        return pd.read_csv(file_name)
    
    # 2. ìƒìœ„ í´ë” í™•ì¸ (pages í´ë” ë‚´ ì‹¤í–‰ ëŒ€ë¹„)
    if os.path.exists(f"../{file_name}"):
        return pd.read_csv(f"../{file_name}")
        
    # 3. íŒŒì¼ ì—†ìœ¼ë©´ ê°€ìƒ ë°ì´í„° ë°˜í™˜
    return create_mock_data()

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
df = load_data()

# -----------------------------------------------------------------------------
# 3. ë©”ì¸ ëŒ€ì‹œë³´ë“œ UI
# -----------------------------------------------------------------------------
st.title("ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­ ì¸ê¸° ê´€ê´‘ì§€ ë°©ë¬¸ í˜„í™©")
st.markdown("ë°ì´í„° ì¶œì²˜ê°€ ì—†ìœ¼ë©´ **ì˜ˆì‹œ ë°ì´í„°**ë¡œ í•œêµ­ ì£¼ìš” ê´€ê´‘ì§€ ë°©ë¬¸ê° ìˆ˜ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.")

# ë°ì´í„° ì •ë³´ í‘œì‹œ (ì‚¬ì´ë“œë°” í™œìš© ê°€ëŠ¥í•˜ì§€ë§Œ ì§ê´€ì ìœ¼ë¡œ ìƒë‹¨ ë°°ì¹˜)
if not os.path.exists("korea_tourism.csv") and not os.path.exists("../korea_tourism.csv"):
    st.info("ğŸ’¡ **ì•Œë¦¼:** ì—…ë¡œë“œëœ ë°ì´í„° íŒŒì¼ì´ ì—†ì–´ **ìƒ˜í”Œ ë°ì´í„°**ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.")

# íƒ­ êµ¬ì„±
tab1, tab2, tab3 = st.tabs(["ğŸ† ì¸ê¸° ìˆœìœ„ TOP 10", "ğŸ“ ì§€ì—­ë³„ í†µê³„", "ğŸ“‹ ì „ì²´ ë°ì´í„°"])

# --- íƒ­ 1: ì¸ê¸° ìˆœìœ„ TOP 10 ---
with tab1:
    st.subheader("ê°€ì¥ ë§ì€ ì‚¬ëŒë“¤ì´ ë°©ë¬¸í•œ ê´€ê´‘ì§€ TOP 10")
    
    # ë°©ë¬¸ê° ìˆ˜ ê¸°ì¤€ ì •ë ¬ ë° TOP 10 ì¶”ì¶œ
    top10 = df.sort_values(by='ë°©ë¬¸ê°ìˆ˜(ë§Œëª…)', ascending=False).head(10)
    
    # ìŠ¤íŠ¸ë¦¼ë¦¿ ë‚´ì¥ ì°¨íŠ¸ëŠ” ì¸ë±ìŠ¤ë¥¼ Xì¶•ìœ¼ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ì„¤ì • í•„ìš”
    chart_data = top10.set_index('ê´€ê´‘ì§€ëª…')[['ë°©ë¬¸ê°ìˆ˜(ë§Œëª…)']]
    
    # ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ë‚´ì¥ ì°¨íŠ¸ ì‚¬ìš© -> í•œê¸€ ê¹¨ì§ ì—†ìŒ)
    st.bar_chart(chart_data, color="#FF4B4B")
    
    st.caption("ë‹¨ìœ„: ë§Œ ëª…")

# --- íƒ­ 2: ì§€ì—­ë³„/ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ ---
with tab2:
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("ì§€ì—­ë³„ ì´ ë°©ë¬¸ê° ìˆ˜")
        # ì§€ì—­ë³„ ê·¸ë£¹í™”
        region_sum = df.groupby('ì§€ì—­')['ë°©ë¬¸ê°ìˆ˜(ë§Œëª…)'].sum().sort_values(ascending=False)
        st.bar_chart(region_sum)
        
    with col2:
        st.subheader("ê´€ê´‘ì§€ ì¹´í…Œê³ ë¦¬ ë¶„í¬")
        # ì¹´í…Œê³ ë¦¬ë³„ ê°œìˆ˜ ì„¸ê¸°
        category_counts = df['ì¹´í…Œê³ ë¦¬'].value_counts()
        st.bar_chart(category_counts)

# --- íƒ­ 3: ì „ì²´ ë°ì´í„° ì¡°íšŒ ---
with tab3:
    st.subheader("ì „ì²´ ë°ì´í„° ëª©ë¡")
    
    # ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    search_term = st.text_input("ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰:")
    if search_term:
        filtered_df = df[df['ê´€ê´‘ì§€ëª…'].str.contains(search_term)]
        st.dataframe(filtered_df, use_container_width=True)
    else:
        st.dataframe(df, use_container_width=True)

    # ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    csv = df.to_csv(index=False).encode('utf-8-sig')
    st.download_button(
        label="ë°ì´í„° CSV ë‹¤ìš´ë¡œë“œ",
        data=csv,
        file_name='korea_tourism_data.csv',
        mime='text/csv',
    )
